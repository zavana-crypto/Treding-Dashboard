<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ZAVANA Market — Signals + Akurasi (%)</title>
<style>
  :root{
    --bg:#0a0f1a; --card:#0e1625; --muted:#9aa5b1; --text:#e5e7eb;
    --accent:#233147; --success:#16a34a; --danger:#ef4444; --warn:#f59e0b;
  }
  html,body{background:var(--bg); color:var(--text); font-family:ui-sans-serif,system-ui; margin:0; padding:0}
  .wrap{max-width:1250px; margin:24px auto; padding:0 16px}
  h1{font-size:22px; margin:0; font-weight:800}
  .muted{color:var(--muted); font-size:12px}
  .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(360px,1fr)); gap:16px; margin-top:16px}
  .card{background:var(--card); border:1px solid var(--accent); border-radius:14px; padding:12px}
  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .badge{border:1px solid var(--accent); padding:4px 8px; border-radius:999px; font-size:12px}
  .countdown{font-variant-numeric:tabular-nums}
  .pill{background:#0b1220; border:1px solid var(--accent); color:#c9d1d9; padding:6px 10px; border-radius:10px; font-weight:800}
  .pill.buy{background:rgba(34,197,94,.12); border-color:rgba(34,197,94,.35); color:#86efac}
  .pill.sell{background:rgba(239,68,68,.12); border-color:rgba(239,68,68,.35); color:#fca5a5}
  .pill.hold{background:rgba(148,163,184,.12); border-color:rgba(148,163,184,.35); color:#cbd5e1}
  .signal-mini .signal-mini-panel{border:1px dashed var(--accent); border-radius:12px; padding:10px; margin-top:8px}
  .tvbox{height:350px; border-radius:10px; overflow:hidden; border:1px solid var(--accent); background:#0b1220;}
  .hdr{display:flex; align-items:center; gap:12px; margin-bottom:12px; border-bottom:1px solid var(--accent); padding-bottom:12px}
  .hdr img.logo{height:40px; width:auto}
  .hdr .titlewrap{display:flex; flex-direction:column}
  .hdr .subtitle{color:var(--muted); font-size:14px; margin-top:2px}
  .toolbar{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px}
  .accrow{display:flex; gap:8px; align-items:center; margin-top:6px}
  .accbar{flex:1; height:8px; background:#0b1220; border:1px solid var(--accent); border-radius:999px; overflow:hidden}
  .accfill{height:100%; width:0%}
  .calendar{margin-top:8px; padding:8px; border:1px solid var(--accent); border-radius:10px; font-size:12px; background:#0b1220; max-height:120px; overflow:auto}
  .calendar h4{margin:0 0 4px 0; font-size:12px; color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <div class="hdr">
    <img src="sound.png" alt="ZAVANA Logo" class="logo"/>
    <div class="titlewrap">
      <h1>ZAVANA Market</h1>
      <div class="subtitle">Signals + Akurasi (%)</div>
    </div>
  </div>

  <div class="grid" id="grid"></div>
</div>

<script>
// === API KEY ANDA ===
const SIG_KEYS = {
  alphaVantage: "XNO2E35DMHUUMKLT",
  twelveData: "dbf42faf2fa648938b9a27c353869bd9",
  finnhub: "d2gd2o9r01qq1lhuh2dgd2gd2o9r01qq1lhuh2e0",
  newsApi: "f9014602d5ae43a7b01032449ff94b63",
  tradingEconomics: "a53fb94a6baa4f8:vd8bjckccsnwoy9"
};

// Tambahkan lebih banyak market di sini
const MARKETS = [
  {title:"EURUSD",  symbol:"EURUSD"},
  {title:"GBPUSD",  symbol:"GBPUSD"},
  {title:"USDJPY",  symbol:"USDJPY"},
  {title:"USDCHF",  symbol:"USDCHF"},
  {title:"AUDUSD",  symbol:"AUDUSD"},
  {title:"USDCAD",  symbol:"USDCAD"},
  {title:"NZDUSD",  symbol:"NZDUSD"},
  {title:"XAUUSD",  symbol:"XAUUSD"},
  {title:"XAGUSD",  symbol:"XAGUSD"},
  {title:"WTIUSD",  symbol:"WTI"},
  {title:"BTCUSD",  symbol:"BTCUSD"},
  {title:"ETHUSD",  symbol:"ETHUSD"}
];

const grid = document.getElementById('grid');

function makeCard(m, idx){
  const id = `m${idx}`;
  const card = document.createElement('div');
  card.className = 'card';
  card.innerHTML = `
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="title">${m.title} <span class="sym muted">(${m.symbol})</span></div>
    </div>
    <div class="tvbox">
      <iframe src="https://s.tradingview.com/widgetembed/?symbol=${m.symbol}&interval=15&hidesidetoolbar=1&symboledit=1&saveimage=1&toolbarbg=f1f3f6&studies=[]&theme=dark&style=1&timezone=Etc/UTC&withdateranges=1&hideideas=1" width="100%" height="100%" frameborder="0" allowtransparency="true" scrolling="no"></iframe>
    </div>
    <div class="signal-mini" data-symbol="${m.symbol}" id="${id}">
      <div class="signal-mini-panel">
        <div class="row" style="align-items:center;gap:8px;margin-top:6px">
          <div class="pill" id="sig-${id}-status">Loading…</div>
          <span class="badge" id="sig-${id}-score">Score: -</span>
          <span class="badge countdown" id="sig-${id}-close">Close ETA: --:--</span>
        </div>
        <div class="accrow">
          <div class="small muted" style="min-width:64px">Akurasi:</div>
          <div class="accbar"><div class="accfill" id="sig-${id}-accfill"></div></div>
          <span class="badge" id="sig-${id}-acc">--%</span>
        </div>
        <div class="calendar" id="cal-${id}">
          <h4>Kalender Ekonomi</h4>
          <div class="muted">Loading…</div>
        </div>
      </div>
    </div>
  `;
  return card;
}
MARKETS.forEach((m,i)=> grid.appendChild(makeCard(m,i)));

// === FETCH DATA ===
async function fetchAlpha(functionName, symbol){
  const url = `https://www.alphavantage.co/query?function=${functionName}&symbol=${symbol}&interval=5min&time_period=10&series_type=close&apikey=${SIG_KEYS.alphaVantage}`;
  const res = await fetch(url);
  return await res.json();
}

async function fetchFinnhub(symbol){
  const url = `https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${SIG_KEYS.finnhub}`;
  const res = await fetch(url);
  return await res.json();
}

async function fetchNews(){
  const url = `https://newsapi.org/v2/top-headlines?category=business&apiKey=${SIG_KEYS.newsApi}`;
  const res = await fetch(url);
  return await res.json();
}

async function fetchCalendar(){
  const url = `https://api.tradingeconomics.com/calendar?c=${SIG_KEYS.tradingEconomics}`;
  const res = await fetch(url);
  return await res.json();
}

function computeAccuracy(score){
  let acc = 50 + Math.abs(score)*10;
  return Math.min(95, Math.max(30, acc));
}

function tintForAcc(acc){
  if(acc>=75) return 'linear-gradient(90deg, rgba(34,197,94,.7), rgba(34,197,94,.35))';
  if(acc>=55) return 'linear-gradient(90deg, rgba(245,158,11,.7), rgba(245,158,11,.35))';
  return 'linear-gradient(90deg, rgba(239,68,68,.7), rgba(239,68,68,.35))';
}

async function runSignalLive(symbol, root){
  const id = root.id;
  const statusEl = root.querySelector(`#sig-${id}-status`);
  const scoreEl  = root.querySelector(`#sig-${id}-score`);
  const closeEl  = root.querySelector(`#sig-${id}-close`);
  const accEl    = root.querySelector(`#sig-${id}-acc`);
  const accFill  = root.querySelector(`#sig-${id}-accfill`);
  const calBox   = root.querySelector(`#cal-${id}`);

  try {
    const [sma, ema, macd, rsi, finnhub, news, calendar] = await Promise.all([
      fetchAlpha("SMA", symbol),
      fetchAlpha("EMA", symbol),
      fetchAlpha("MACD", symbol),
      fetchAlpha("RSI", symbol),
      fetchFinnhub(symbol),
      fetchNews(),
      fetchCalendar()
    ]);

    let score = 0;

    // SMA check
    if(sma['Technical Analysis: SMA']) score += 1;
    // EMA check
    if(ema['Technical Analysis: EMA']) score += 1;
    // MACD bullish / bearish
    if(macd['Technical Analysis: MACD']){
      const last = Object.values(macd['Technical Analysis: MACD'])[0];
      if(last.MACD > last['MACD_Signal']) score += 1; else score -= 1;
    }
    // RSI check
    if(rsi['Technical Analysis: RSI']){
      const last = Object.values(rsi['Technical Analysis: RSI'])[0];
      const val = parseFloat(last.RSI);
      if(val < 30) score += 1; // oversold => buy
      if(val > 70) score -= 1; // overbought => sell
    }

    // Finnhub harga live
    if(finnhub.c && finnhub.o){
      if(finnhub.c > finnhub.o) score += 1;
      else score -= 1;
    }

    // News sentiment sederhana
    if(news.articles && news.articles.length>0){
      const sentiment = news.articles.slice(0,5).map(a=>a.title+" "+a.description).join(" ");
      if(/up|gain|bullish|positive/i.test(sentiment)) score += 1;
      if(/down|fall|bearish|negative/i.test(sentiment)) score -= 1;
    }

    let labelRaw = score>0?"BUY":score<0?"SELL":"HOLD";
    const label = (labelRaw==="BUY"?"Open BUY sekarang":labelRaw==="SELL"?"Open SELL sekarang":"HOLD / Tunggu");
    statusEl.textContent = label;
    statusEl.className = "pill " + (labelRaw==="BUY"?"buy":labelRaw==="SELL"?"sell":"hold");
    scoreEl.textContent = "Score: " + score;

    const acc = computeAccuracy(score);
    accEl.textContent = acc + "%";
    accFill.style.width = acc + "%";
    accFill.style.background = tintForAcc(acc);

    closeEl.textContent = "Close ETA: 00:30:00";

    if(calendar && Array.isArray(calendar)){
      calBox.innerHTML = "<h4>Kalender Ekonomi</h4>" +
        calendar.slice(0,5).map(ev=> `<div>${new Date(ev.Date).toLocaleString()} — ${ev.Country}: ${ev.Event} (${ev.Actual||''})</div>`).join("");
    }
  } catch(e){
    statusEl.textContent = "Error fetch data";
    calBox.innerHTML = "<h4>Kalender Ekonomi</h4><div class='muted'>Error load</div>";
  }
}

// === Jalankan otomatis saat load ===
window.addEventListener('load', ()=>{
  document.querySelectorAll('.signal-mini').forEach(root=>{
    runSignalLive(root.getAttribute('data-symbol'), root);
  });
});
</script>
</body>
</html>
