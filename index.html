<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>ZAVANA V18.1 MOBILE</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
<!-- EmailJS SDK -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

<!-- FIREBASE SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
  :root{ 
      --bg-base: #050607; 
      --bg-sidebar: #0d1117;
      --bg-card: #161b22; 
      --bg-hover: #21262d;
      --text-primary: #f0f6fc; 
      --text-secondary: #8b949e; 
      --accent: #58a6ff;
      --gold: #d2a106; 
      --binance-green: #238636;
      --binance-green-glow: #3fb950;
      --binance-red: #da3633;
      --binance-red-glow: #f85149;
      --border: #30363d; 
      --nav-width: 240px;
  }
  
  body { background:var(--bg-base); color:var(--text-primary); font-family:'Inter', sans-serif; margin:0; overflow: hidden; height: 100vh; display: flex; }
  
  /* SIDEBAR NAV */
  .sidebar { width: var(--nav-width); background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; z-index: 100; height: 100vh; box-sizing: border-box; flex-shrink: 0; }
  .brand { font-family: 'JetBrains Mono', monospace; font-size: 20px; font-weight: 800; color: var(--text-primary); display: flex; align-items: center; gap: 10px; margin-bottom: 30px; }
  .brand span { color: var(--bg-base); background: var(--gold); font-size: 10px; padding: 3px 6px; border-radius: 4px; }
  
  .nav-menu { display: flex; flex-direction: column; gap: 8px; flex: 1; }
  .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 6px; color: var(--text-secondary); cursor: pointer; transition: 0.2s; font-weight: 600; font-size: 14px; text-decoration: none; }
  .nav-item:hover { background: var(--bg-hover); color: var(--text-primary); }
  .nav-item.active { background: rgba(88, 166, 255, 0.1); color: var(--accent); border-left: 3px solid var(--accent); }
  .nav-icon { width: 18px; text-align: center; font-size: 16px; }

  .nav-footer { margin-top: auto; border-top: 1px solid var(--border); padding-top: 20px; display: flex; flex-direction: column; gap: 10px; }
  .status-item { font-size: 11px; color: var(--text-secondary); display: flex; justify-content: space-between; font-family: 'JetBrains Mono'; }
  
  .action-btn { background: rgba(255,255,255,0.05); color: var(--text-secondary); border: 1px solid var(--border); padding: 10px; border-radius: 6px; text-align: center; cursor: pointer; font-size: 12px; font-weight: 700; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
  .action-btn:hover { background: var(--bg-hover); }
  
  .cloud-btn.synced { background: rgba(88, 166, 255, 0.2); color: var(--accent); border-color: var(--accent); }
  .wakelock-btn.active { background: rgba(210, 161, 6, 0.2); color: var(--gold); border-color: var(--gold); animation: pulse 2s infinite; }
  
  @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

  /* MAIN CONTENT */
  .main-content { flex: 1; overflow-y: auto; position: relative; scroll-behavior: smooth; }
  .page { display: none; padding: 20px; max-width: 1400px; margin: 0 auto; animation: fadeIn 0.3s ease; }
  .page.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
  .page-title { font-size: 24px; font-weight: 800; letter-spacing: -0.5px; }

  /* COMPONENT: TOOLBAR */
  .toolbar-wrapper { background: var(--bg-card); padding: 8px; border-radius: 8px; border: 1px solid var(--border); display: inline-flex; gap: 4px; flex-wrap: wrap; }
  .tf-btn { background:transparent; color:var(--text-secondary); border:none; padding:6px 14px; cursor:pointer; font-weight:600; font-size:13px; border-radius:6px; font-family: 'JetBrains Mono'; transition:0.2s; }
  .tf-btn:hover { color:var(--text-primary); background:var(--bg-hover); }
  .tf-btn.active { background: var(--bg-hover); color: var(--text-primary); border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

  /* COMPONENT: GRID */
  .grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(350px, 1fr)); gap:20px; }
  .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; display: flex; flex-direction: column; gap: 12px; transition: 0.3s; position: relative; }
  .card:hover { transform: translateY(-4px); border-color: var(--text-secondary); }
  
  .card.sniper-buy { border-color: var(--binance-green-glow); box-shadow: 0 0 20px rgba(63, 185, 80, 0.15); }
  .card.sniper-sell { border-color: var(--binance-red-glow); box-shadow: 0 0 20px rgba(248, 81, 73, 0.15); }
  
  .c-head { display:flex; justify-content:space-between; align-items:flex-start; }
  .pair-info { display:flex; align-items: center; gap: 10px; }
  .pair-icon { width:32px; height:32px; border-radius:50%; background:#222; }
  .pair-name { font-size:16px; font-weight:700; color:var(--text-primary); }
  
  .badges { display: flex; gap: 6px; margin-top: 4px; }
  .badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 700; font-family: 'JetBrains Mono'; border: 1px solid transparent; }
  .badge.htf-bull { color: var(--binance-green-glow); background: rgba(35, 134, 54, 0.1); border-color: rgba(35, 134, 54, 0.3); }
  .badge.htf-bear { color: var(--binance-red-glow); background: rgba(218, 54, 51, 0.1); border-color: rgba(218, 54, 51, 0.3); }
  
  .price-box { text-align:right; }
  .live-price { font-size:18px; font-weight:700; font-family:'JetBrains Mono'; }
  .c-up { color:var(--binance-green-glow); } .c-down { color:var(--binance-red-glow); }

  .chart-wrapper { height:160px; width:100%; border-radius:8px; overflow:hidden; border:1px solid var(--border); background: #010409; position: relative; }
  
  .score-bar-bg { height: 4px; background: var(--bg-hover); border-radius: 2px; overflow: hidden; margin-top: 4px; display: flex; }
  .score-fill { height: 100%; width: 0%; transition: width 0.5s ease; }
  .score-fill.buy { background: var(--binance-green-glow); }
  .score-fill.sell { background: var(--binance-red-glow); }
  
  .ai-panel { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1px; background: var(--border); border-radius: 6px; overflow: hidden; opacity: 0.6; transition: 0.3s; }
  .ai-panel.active { opacity: 1; border: 1px solid var(--text-secondary); }
  .ai-box { background: var(--bg-card); padding: 6px; text-align: center; }
  .ai-lbl { font-size: 9px; color: var(--text-secondary); font-weight: 700; }
  .ai-val { font-size: 11px; font-family: 'JetBrains Mono'; font-weight: 600; }
  
  .action-row { display: flex; gap: 10px; }
  .sig-btn { flex: 1; display: flex; justify-content: space-between; padding: 8px 12px; border-radius: 6px; background: var(--bg-hover); font-size: 12px; font-weight: 700; color: var(--text-secondary); opacity: 0.5; border: 1px solid transparent; text-decoration: none; align-items: center;}
  .sig-btn span.score { font-size: 10px; opacity: 0.7; font-family: 'JetBrains Mono'; }
  
  .sig-btn.active.buy { opacity: 1; background: rgba(35, 134, 54, 0.2); color: var(--binance-green-glow); border-color: var(--binance-green-glow); }
  .sig-btn.active.sell { opacity: 1; background: rgba(218, 54, 51, 0.2); color: var(--binance-red-glow); border-color: var(--binance-red-glow); }

  /* TABLE */
  .table-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
  table { width: 100%; border-collapse: collapse; font-size: 14px; }
  th { text-align: left; padding: 16px; color: var(--text-secondary); border-bottom: 1px solid var(--border); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; background: var(--bg-sidebar); }
  td { padding: 16px; border-bottom: 1px solid var(--border); color: var(--text-primary); }
  tr:last-child td { border-bottom: none; }
  tr:hover { background: var(--bg-hover); }
  .col-price { font-family: 'JetBrains Mono'; font-weight: 600; }
  .tag { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; }
  .tag.bull { background: rgba(35, 134, 54, 0.2); color: var(--binance-green-glow); }
  .tag.bear { background: rgba(218, 54, 51, 0.2); color: var(--binance-red-glow); }
  
  /* SETTINGS */
  .settings-form { max-width: 600px; }
  .form-group { margin-bottom: 20px; }
  .form-group label { display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 13px; font-weight: 600; }
  .form-group input, .form-group textarea { width: 100%; background: var(--bg-sidebar); border: 1px solid var(--border); padding: 12px; color: var(--text-primary); border-radius: 6px; font-family: 'JetBrains Mono'; font-size: 13px; box-sizing: border-box; }
  .form-group input:focus, .form-group textarea:focus { border-color: var(--accent); outline: none; }
  .btn-primary { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 700; cursor: pointer; transition: 0.2s; }
  .btn-primary:hover { background: #79c0ff; }

  @media (max-width: 768px) {
      body { flex-direction: column; overflow: auto; height: auto; }
      .sidebar { width: 100%; height: auto; padding: 10px; border-right: none; border-bottom: 1px solid var(--border); flex-direction: row; align-items: center; justify-content: space-between; position: sticky; top: 0; }
      .brand { margin-bottom: 0; font-size: 18px; }
      .nav-menu { flex-direction: row; gap: 4px; overflow-x: auto; flex: initial; }
      .nav-item { padding: 8px; font-size: 12px; }
      .nav-footer { display: none; } /* Use settings page for toggles on mobile if needed */
      .page-title { font-size: 18px; }
  }
</style>
</head>
<body>

<!-- 1. SIDEBAR NAVIGATION -->
<nav class="sidebar">
    <div class="brand">ZAVANA <span>V18.1</span></div>
    
    <div class="nav-menu">
        <div class="nav-item active" onclick="showPage('dashboard', this)">
            <span class="nav-icon">üìä</span> Dashboard
        </div>
        <div class="nav-item" onclick="showPage('screener', this)">
            <span class="nav-icon">üìã</span> Market List
        </div>
        <div class="nav-item" onclick="showPage('settings', this)">
            <span class="nav-icon">‚öô</span> Settings
        </div>
    </div>

    <div class="nav-footer">
        <div id="wakeLockBtn" class="action-btn wakelock-btn" onclick="toggleWakeLock()">üí° ACTIVE MODE</div>
        <div id="cloudBtn" class="action-btn cloud-btn" onclick="toggleCloudSync()">‚òÅ SYNC DATA</div>
        <div class="status-item"><span>PING</span><span id="pingDisplay">--ms</span></div>
        <div class="status-item"><span>WS</span><span id="wsText">INIT</span></div>
    </div>
</nav>

<!-- 2. MAIN CONTENT AREA -->
<main class="main-content">
    
    <!-- PAGE 1: DASHBOARD -->
    <div id="page-dashboard" class="page active">
        <div class="page-header">
            <div class="page-title">Live Scanner</div>
            <div class="toolbar-wrapper" id="tfToolbar"></div>
        </div>
        <div class="grid" id="grid">
            <!-- Charts injected here -->
        </div>
    </div>

    <!-- PAGE 2: MARKET LIST (SCREENER) -->
    <div id="page-screener" class="page">
        <div class="page-header">
            <div class="page-title">Market Overview</div>
            <div style="font-size: 12px; color: var(--text-secondary);">Real-time summary of all assets</div>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Asset</th>
                        <th>Price</th>
                        <th>Trend</th>
                        <th>RSI</th>
                        <th>Score</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="screenerTable">
                    <!-- Rows injected here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- PAGE 3: SETTINGS -->
    <div id="page-settings" class="page">
        <div class="page-header">
            <div class="page-title">Configuration</div>
        </div>
        
        <div class="settings-form">
            <h4 style="margin-bottom: 15px;">Mobile Controls</h4>
            <!-- Duplicate Wake Lock for Mobile View where Footer is hidden -->
            <div id="wakeLockBtnMobile" class="action-btn wakelock-btn" onclick="toggleWakeLock()" style="margin-bottom: 20px;">
                üí° TOGGLE ACTIVE MODE (KEEP SCREEN ON)
            </div>

            <div class="form-group">
                <label>Watchlist Assets (Comma separated)</label>
                <textarea id="coinInput" rows="4"></textarea>
            </div>
            
            <div style="margin: 20px 0; border-top: 1px solid var(--border);"></div>
            <h4 style="margin-bottom: 15px;">Email Notification (EmailJS)</h4>
            
            <div class="form-group">
                <label>Service ID</label>
                <input type="text" id="emailServiceId">
            </div>
            <div class="form-group">
                <label>Template ID</label>
                <input type="text" id="emailTemplateId">
            </div>
            <div class="form-group">
                <label>Public Key</label>
                <input type="text" id="emailPublicKey">
            </div>

            <button class="btn-primary" onclick="saveSettings()">Save Configuration</button>
        </div>
    </div>

</main>

<script>
/* =========================================
   CORE CONFIG
   ========================================= */
const DEFAULT_COINS = ["BTCUSDT", "ETHUSDT", "BNBUSDT", "SOLUSDT", "XRPUSDT", "DOGEUSDT", "ADAUSDT", "TRXUSDT", "PAXGUSDT"];
let COINS = JSON.parse(localStorage.getItem('zavana_coins')) || DEFAULT_COINS;
let EMAIL_CONFIG = JSON.parse(localStorage.getItem('zavana_email_config')) || { serviceId: '', templateId: '', publicKey: '' };

const TIMEFRAMES = [
  { label: '1m',  ws: '1m',  cc: 'histominute', limit: 60, seconds: 60, agg: 1 },
  { label: '5m',  ws: '5m',  cc: 'histominute', limit: 300, seconds: 300, agg: 1 },
  { label: '15m', ws: '15m', cc: 'histominute', limit: 900, seconds: 900, agg: 1 },
  { label: '1H',  ws: '1h',  cc: 'histohour',   limit: 60, seconds: 3600, agg: 1 },
  { label: '4H',  ws: '4h',  cc: 'histohour',   limit: 240, seconds: 14400, agg: 1 },
  { label: '1D',  ws: '1d',  cc: 'histoday',    limit: 100, seconds: 86400, agg: 1 },
  { label: '1W',  ws: '1w',  cc: 'histoday',    limit: 52,  seconds: 604800, agg: 7 }
];

let CURRENT_TF = TIMEFRAMES[2]; // Default 15m
let ws = null;
const charts = new Map();
const marketData = new Map();
const htfMarketData = new Map();
const analysisResults = new Map(); 
const audioCooldown = new Map(); 
let wakeLock = null; // Wake Lock Handle

/* =========================================
   MOBILE WAKE LOCK & AUDIO
   ========================================= */
async function toggleWakeLock() {
    if ('wakeLock' in navigator) {
        if (wakeLock) {
            await wakeLock.release();
            wakeLock = null;
            updateWakeLockUI(false);
        } else {
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                wakeLock.addEventListener('release', () => {
                    wakeLock = null;
                    updateWakeLockUI(false);
                });
                updateWakeLockUI(true);
                alert("Active Mode ON: Screen will stay awake for alerts.");
            } catch (err) {
                alert(`Wake Lock Error: ${err.name}, ${err.message}`);
            }
        }
    } else {
        alert("Wake Lock not supported in this browser.");
    }
}

function updateWakeLockUI(active) {
    const btns = document.querySelectorAll('.wakelock-btn');
    btns.forEach(btn => {
        if(active) {
            btn.classList.add('active');
            btn.innerHTML = 'üí° ACTIVE MODE (ON)';
        } else {
            btn.classList.remove('active');
            btn.innerHTML = 'üí° ACTIVE MODE (OFF)';
        }
    });
}

// Simple Audio Tone
const AudioContext = window.AudioContext || window.webkitAudioContext;
let audioCtx;

function playBeep() {
    if (!audioCtx) audioCtx = new AudioContext();
    if (audioCtx.state === 'suspended') audioCtx.resume();
    
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    
    osc.type = 'sine';
    osc.frequency.setValueAtTime(880, audioCtx.currentTime); // A5
    osc.frequency.exponentialRampToValueAtTime(440, audioCtx.currentTime + 0.5);
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
    
    osc.start();
    osc.stop(audioCtx.currentTime + 0.5);
}

// Unlock Audio on First Click
document.addEventListener('click', () => {
    if (!audioCtx) audioCtx = new AudioContext();
    if (audioCtx.state === 'suspended') audioCtx.resume();
}, { once: true });


/* =========================================
   APP LOGIC
   ========================================= */
function startApp() {
    renderToolbar();
    renderGrid();
    initSettingsForm(); 
    if(EMAIL_CONFIG.publicKey) emailjs.init(EMAIL_CONFIG.publicKey);
    changeTimeframe(CURRENT_TF);
    setInterval(updateTimers, 1000);
    setInterval(updateScreenerTable, 2000); 
}

// NAVIGATION LOGIC
window.showPage = function(pageId, btn) {
    document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
    document.getElementById(`page-${pageId}`).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    if(btn) btn.classList.add('active');
    if(pageId === 'screener') updateScreenerTable();
}

function renderToolbar() {
    const bar = document.getElementById('tfToolbar');
    bar.innerHTML = '';
    TIMEFRAMES.forEach(tf => {
        const btn = document.createElement('button');
        btn.className = `tf-btn ${tf.label === CURRENT_TF.label ? 'active' : ''}`;
        btn.textContent = tf.label;
        btn.onclick = () => changeTimeframe(tf);
        bar.appendChild(btn);
    });
}

function renderGrid() {
    const grid = document.getElementById('grid');
    grid.innerHTML = ''; 
    COINS.forEach(sym => {
        const s = sym.trim().toUpperCase();
        const base = s.replace('USDT','');
        const isGold = s === "PAXGUSDT";
        const icon = isGold ? "https://assets.coincap.io/assets/icons/paxg@2x.png" : `https://assets.coincap.io/assets/icons/${base.toLowerCase()}@2x.png`;
        
        const card = document.createElement('div');
        card.className = 'card';
        card.id = `card-${s}`;
        card.innerHTML = `
            <div class="c-head">
                <div class="pair-info">
                    <img src="${icon}" class="pair-icon" onerror="this.style.display='none'">
                    <div>
                        <div class="pair-name" style="${isGold?'color:var(--gold)':''}">${isGold?'GOLD':base}</div>
                        <div class="badges">
                           <span class="badge" id="htf-${s}">HTF:-</span>
                           <span class="badge" id="pat-${s}">-</span>
                        </div>
                    </div>
                </div>
                <div class="price-box">
                    <div class="live-price" id="price-${s}">---</div>
                </div>
            </div>
            
            <div class="score-bar-bg">
                <div class="score-fill" id="score-${s}"></div>
            </div>

            <div class="chart-wrapper">
                <div id="chart-${s}" style="width:100%; height:100%"></div>
            </div>
            
            <div class="ai-panel" id="ai-${s}">
                <div class="ai-box"><span class="ai-lbl">ENTRY</span><span class="ai-val" id="e-${s}">-</span></div>
                <div class="ai-box"><span class="ai-lbl">TP</span><span class="ai-val val-tp" id="tp-${s}">-</span></div>
                <div class="ai-box"><span class="ai-lbl">SL</span><span class="ai-val val-sl" id="sl-${s}">-</span></div>
            </div>

            <div class="action-row">
                <a href="https://www.binance.com/en/trade/${base}_USDT?type=spot" target="_blank" class="sig-btn buy" id="btn-buy-${s}">
                   BUY <span class="score" id="sc-buy-${s}">0.0</span>
                </a>
                <a href="https://www.binance.com/en/trade/${base}_USDT?type=spot" target="_blank" class="sig-btn sell" id="btn-sell-${s}">
                   SELL <span class="score" id="sc-sell-${s}">0.0</span>
                </a>
            </div>
        `;
        grid.appendChild(card);
        
        // Init Chart
        const cont = document.getElementById(`chart-${s}`);
        const chart = LightweightCharts.createChart(cont, {
            layout: { backgroundColor: '#010409', textColor: '#8b949e', fontSize: 10, fontFamily: 'JetBrains Mono' },
            grid: { vertLines: { color: '#161b22' }, horzLines: { color: '#161b22' } },
            rightPriceScale: { borderVisible: false, scaleMargins: { top: 0.1, bottom: 0.1 } },
            timeScale: { visible: false, borderVisible: false },
            handleScroll: false, handleScale: false
        });
        const series = chart.addCandlestickSeries({ upColor: '#238636', downColor: '#da3633', borderVisible: false });
        const ema = chart.addLineSeries({ color: '#58a6ff', lineWidth:1 });
        
        new ResizeObserver(e => { if(e[0]) chart.applyOptions({ width: e[0].contentRect.width, height: e[0].contentRect.height }); }).observe(cont);
        charts.set(s, { chart, series, ema });
        marketData.set(s, []);
    });
}

function updateScreenerTable() {
    const tbody = document.getElementById('screenerTable');
    if(!document.getElementById('page-screener').classList.contains('active')) return;
    
    let html = '';
    COINS.forEach(sym => {
        const res = analysisResults.get(sym) || {};
        const base = sym.replace('USDT','');
        
        const trendClass = res.trend === 'BULLISH' ? 'bull' : 'bear';
        const sigClass = res.signal === 'BUY' ? 'bull' : (res.signal === 'SELL' ? 'bear' : '');
        const scoreVal = Math.max(res.bScore||0, res.sScore||0).toFixed(1);

        html += `
            <tr>
                <td><b>${base}</b></td>
                <td class="col-price">${res.price || '---'}</td>
                <td><span class="tag ${trendClass}">${res.trend || 'WAIT'}</span></td>
                <td>${res.rsi ? res.rsi.toFixed(1) : '-'}</td>
                <td><span class="tag">${scoreVal}</span></td>
                <td><a href="https://www.binance.com/en/trade/${base}_USDT" target="_blank" style="color:var(--accent); text-decoration:none;">Trade ‚Üó</a></td>
            </tr>
        `;
    });
    tbody.innerHTML = html;
}

function initSettingsForm() {
    document.getElementById('coinInput').value = COINS.join(', ');
    document.getElementById('emailServiceId').value = EMAIL_CONFIG.serviceId;
    document.getElementById('emailTemplateId').value = EMAIL_CONFIG.templateId;
    document.getElementById('emailPublicKey').value = EMAIL_CONFIG.publicKey;
}

window.saveSettings = function() {
    const raw = document.getElementById('coinInput').value;
    const newCoins = raw.split(',').map(s => s.trim().toUpperCase()).filter(s => s.length > 0);
    
    EMAIL_CONFIG.serviceId = document.getElementById('emailServiceId').value;
    EMAIL_CONFIG.templateId = document.getElementById('emailTemplateId').value;
    EMAIL_CONFIG.publicKey = document.getElementById('emailPublicKey').value;

    COINS = newCoins;
    localStorage.setItem('zavana_coins', JSON.stringify(COINS));
    localStorage.setItem('zavana_email_config', JSON.stringify(EMAIL_CONFIG));
    
    saveCloudData();
    alert("Settings Saved! App will refresh.");
    location.reload(); 
}

/* =========================================
   DATA & ANALYSIS
   ========================================= */
async function changeTimeframe(tf) {
    CURRENT_TF = tf;
    document.querySelectorAll('.tf-btn').forEach(b => b.classList.toggle('active', b.textContent === tf.label));
    if(ws) ws.close();
    document.getElementById('wsText').textContent = 'CONN...';
    
    // UPDATED HTF MAP
    const HTF_MAP = { 
        '1m': '1H', '5m': '4H', 
        '15m':'4H', '1H':'1D', '4H':'1D', '1D':'1W', '1W':'1W' 
    };
    const htfLabel = HTF_MAP[tf.label] || '1D';
    const htfObj = TIMEFRAMES.find(t => t.label === htfLabel) || TIMEFRAMES[5];

    for (const sym of COINS) {
        // Fetch Main Data
        const hist = await fetchHistory(sym, tf.cc, tf.limit, tf.agg);
        // Fetch HTF Data
        const htfHist = await fetchHistory(sym, htfObj.cc, 100, htfObj.agg);
        
        if(htfHist.length) htfMarketData.set(sym, htfHist);

        if(hist.length) {
            marketData.set(sym, hist);
            const cObj = charts.get(sym);
            if(cObj) {
                cObj.series.setData(hist);
                cObj.ema.setData(calcEMAData(hist, 200));
                analyze(sym, hist);
            }
        }
    }
    
    const streams = COINS.map(c => `${c.toLowerCase()}@kline_${tf.ws}`).join('/');
    ws = new WebSocket(`wss://stream.binance.com:9443/stream?streams=${streams}`);
    ws.onopen = () => { document.getElementById('wsText').textContent = 'LIVE'; };
    ws.onmessage = (e) => {
        try {
            const msg = JSON.parse(e.data);
            const k = msg.data.k;
            const c = { time: k.t/1000, open: +k.o, high: +k.h, low: +k.l, close: +k.c, volume: +k.v };
            handleStream(msg.data.s, c);
            const ms = Date.now() - msg.data.E;
            document.getElementById('pingDisplay').textContent = `${ms}ms`;
        } catch(err) {}
    };
}

async function fetchHistory(s, ep, lim, agg = 1) {
    try {
        const res = await fetch(`https://min-api.cryptocompare.com/data/v2/${ep}?fsym=${s.replace('USDT','')}&tsym=USDT&limit=${lim}&aggregate=${agg}`);
        const j = await res.json();
        return j.Data.Data.map(d=>({time:d.time,open:d.open,high:d.high,low:d.low,close:d.close,volume:d.volumeto}));
    } catch(e) { return []; }
}

function handleStream(sym, candle) {
    const arr = marketData.get(sym);
    if(!arr) return;
    const last = arr[arr.length-1];
    if (candle.time === last.time) arr[arr.length-1] = candle;
    else if (candle.time > last.time) { arr.push(candle); if(arr.length>500) arr.shift(); }
    
    const cObj = charts.get(sym);
    if(cObj) {
        cObj.series.update(candle);
        const emaVal = calcEMA(arr, 200);
        if(emaVal) cObj.ema.update({ time: candle.time, value: emaVal });
    }
    
    const pEl = document.getElementById(`price-${sym}`);
    if(pEl) {
        const prev = parseFloat(pEl.getAttribute('data-p')||0);
        pEl.textContent = candle.close.toFixed(candle.close<1?4:2);
        pEl.className = `live-price ${candle.close>=prev?'c-up':'c-down'}`;
        pEl.setAttribute('data-p', candle.close);
    }
    analyze(sym, arr);
}

/* =========================================
   ADVANCED ANALYSIS LOGIC (V15 RESTORED)
   ========================================= */
function analyze(sym, data) {
    if(data.length < 50) return;
    const last = data[data.length-1];
    const prev = data[data.length-2];
    
    // Indicators
    const rsi = calcRSI(data, 14);
    const stoch = calcStochRSI(data, 14, 14, 3, 3);
    const ema200 = calcEMA(data, 200);
    const bb = calcBB(data, 20, 2);
    const atr = calcATR(data, 14);
    
    // HTF Trend
    let htfTrend = 'WAIT';
    const htfD = htfMarketData.get(sym);
    if(htfD && htfD.length > 50) {
        const htfEma = calcEMA(htfD, 200);
        if(htfEma) htfTrend = htfD[htfD.length-1].close > htfEma ? 'BULL' : 'BEAR';
    }

    // Pattern Recognition
    let pattern = '';
    let patScore = 0;
    const isBullEngulf = prev.close < prev.open && last.close > last.open && last.open <= prev.close && last.close >= prev.open;
    const isBearEngulf = prev.close > prev.open && last.close < last.open && last.open >= prev.close && last.close <= prev.open;
    
    if(isBullEngulf) { pattern = 'ENGULF+'; patScore = 2; }
    if(isBearEngulf) { pattern = 'ENGULF-'; patScore = -2; }

    // Scoring
    let bScore = 0, sScore = 0;
    const trend = last.close > ema200 ? 'BULLISH' : 'BEARISH';
    
    // Base Trend Points
    if(trend === 'BULLISH') bScore += 2; else sScore += 2;
    
    // Stoch RSI (Sensitivity Tuned)
    // If Stoch is oversold (<20) and curving up -> Buy Signal
    if(stoch.k < 25 && stoch.k > stoch.d) bScore += 3;
    if(stoch.k > 75 && stoch.k < stoch.d) sScore += 3;

    // RSI
    if(rsi < 40) bScore += 1; // More lenient (was 35)
    if(rsi > 60) sScore += 1; // More lenient (was 65)

    // BB Rejection
    if(last.close < bb.lower) bScore += 2;
    if(last.close > bb.upper) sScore += 2;
    
    // Pattern
    if(patScore > 0) bScore += patScore;
    if(patScore < 0) sScore += Math.abs(patScore);
    
    // HTF Filter (Softened)
    if(htfTrend === 'BEAR') bScore -= 2; // Was 4
    if(htfTrend === 'BULL') sScore -= 2; // Was 4
    
    bScore = Math.max(0, Math.min(10, bScore));
    sScore = Math.max(0, Math.min(10, sScore));
    
    let signal = 'WAIT';
    // Lower threshold slightly to 7.0 for more frequency
    if(bScore >= 7.0 && bScore > sScore) signal = 'BUY';
    if(sScore >= 7.0 && sScore > bScore) signal = 'SELL';
    
    // Store
    analysisResults.set(sym, { price: last.close, trend: trend, rsi: rsi, signal: signal, bScore, sScore });
    
    // UI Updates
    updateCardUI(sym, signal, bScore, sScore, trend, htfTrend, pattern, last, atr);
    
    if(signal !== 'WAIT') triggerAlert(sym, signal);
}

function updateCardUI(sym, sig, bs, ss, trend, htf, pat, last, atr) {
    const card = document.getElementById(`card-${sym}`);
    if(!card) return;

    // HTF Badge
    const htfEl = document.getElementById(`htf-${sym}`);
    htfEl.textContent = `HTF:${htf}`;
    htfEl.className = `badge ${htf==='BULL'?'htf-bull':(htf==='BEAR'?'htf-bear':'')}`;
    
    // Pattern
    const patEl = document.getElementById(`pat-${sym}`);
    patEl.textContent = pat;
    patEl.style.color = pat.includes('+') ? 'var(--binance-green-glow)' : 'var(--binance-red-glow)';

    // Score Bar
    const maxScore = Math.max(bs, ss);
    const scoreBar = document.getElementById(`score-${sym}`);
    scoreBar.style.width = `${(maxScore/10)*100}%`;
    scoreBar.className = `score-fill ${bs > ss ? 'buy' : 'sell'}`;

    // Buttons
    document.getElementById(`sc-buy-${sym}`).textContent = bs.toFixed(1);
    document.getElementById(`sc-sell-${sym}`).textContent = ss.toFixed(1);
    
    const btnBuy = document.getElementById(`btn-buy-${sym}`);
    const btnSell = document.getElementById(`btn-sell-${sym}`);
    btnBuy.className = `sig-btn buy ${sig==='BUY'?'active':''}`;
    btnSell.className = `sig-btn sell ${sig==='SELL'?'active':''}`;
    
    // Card Glow
    card.className = `card ${sig==='BUY'?'sniper-buy':(sig==='SELL'?'sniper-sell':'')}`;
    
    // AI Panel
    const aiPanel = document.getElementById(`ai-${sym}`);
    if(sig !== 'WAIT') {
        aiPanel.classList.add('active');
        const sl = sig==='BUY' ? last.close - (atr*2) : last.close + (atr*2);
        const tp = sig==='BUY' ? last.close + (atr*3) : last.close - (atr*3);
        document.getElementById(`e-${sym}`).textContent = last.close.toFixed(last.close<1?4:2);
        document.getElementById(`tp-${sym}`).textContent = tp.toFixed(last.close<1?4:2);
        document.getElementById(`sl-${sym}`).textContent = sl.toFixed(last.close<1?4:2);
    } else {
        aiPanel.classList.remove('active');
    }
}

/* =========================================
   UTILS
   ========================================= */
function calcEMA(d,p){if(d.length<p)return null;const k=2/(p+1);let e=d[0].close;for(let i=1;i<d.length;i++)e=(d[i].close*k)+(e*(1-k));return e;}
function calcEMAData(d,p){let r=[];if(d.length<p)return r;const k=2/(p+1);let e=d[0].close;for(let i=0;i<d.length;i++){e=(d[i].close*k)+(e*(1-k));if(i>=p)r.push({time:d[i].time,value:e});}return r;}
function calcRSI(d,p){if(d.length<p+1)return 50;let g=0,l=0;for(let i=1;i<=p;i++){let x=d[i].close-d[i-1].close;if(x>=0)g+=x;else l-=x;}let ag=g/p,al=l/p;for(let i=p+1;i<d.length;i++){let x=d[i].close-d[i-1].close;ag=((ag*(p-1))+(x>0?x:0))/p;al=((al*(p-1))+(x<0?-x:0))/p;}return al===0?100:100-(100/(1+(ag/al)));}
function calcATR(d,p){if(d.length<p+1)return 0;let s=0;for(let i=d.length-p;i<d.length;i++)s+=Math.max(d[i].high-d[i].low,Math.abs(d[i].high-d[i-1].close),Math.abs(d[i].low-d[i-1].close));return s/p;}
function calcBB(d,p,m){if(d.length<p)return{upper:0,lower:0};const s=d.slice(-p),avg=s.reduce((a,b)=>a+b.close,0)/p,sd=Math.sqrt(s.map(x=>Math.pow(x.close-avg,2)).reduce((a,b)=>a+b,0)/p);return{upper:avg+(sd*m),lower:avg-(sd*m)};}

function calcStochRSI(d, rsiP, stochP, kP, dP) {
    if(d.length < (rsiP + stochP + kP)) return {k:50, d:50};
    // 1. RSI
    let rsiArr = [];
    for(let i=0; i<d.length; i++) {
        if(i < rsiP) { rsiArr.push(50); continue; }
        let g=0, l=0;
        for(let j=i-rsiP+1; j<=i; j++) {
            let x = d[j].close - d[j-1].close;
            if(x>=0) g+=x; else l-=x;
        }
        rsiArr.push(l===0?100:100-(100/(1+(g/l))));
    }
    // 2. StochRSI
    let stochArr = [];
    for(let i=0; i<rsiArr.length; i++) {
        if(i < rsiP + stochP) { stochArr.push(0); continue; }
        let slice = rsiArr.slice(i-stochP+1, i+1);
        let min = Math.min(...slice);
        let max = Math.max(...slice);
        stochArr.push(max===min ? 0 : (rsiArr[i]-min)/(max-min));
    }
    // 3. K & D (SMA)
    const sma = (arr, p, idx) => {
        if(idx < p) return 0.5;
        let s=0; for(let j=idx-p+1; j<=idx; j++) s+=arr[j]; return s/p;
    };
    let k = sma(stochArr, kP, stochArr.length-1) * 100;
    let dVal = k; 
    return { k: k, d: dVal };
}

function triggerAlert(sym, type) {
    const now = Date.now();
    if(now - (audioCooldown.get(sym)||0) > 60000) {
        if(Notification.permission==='granted') new Notification(`ZAVANA ${type}: ${sym}`);
        playBeep(); // Audio Alert
        audioCooldown.set(sym, now);
    }
}
function updateTimers() {}

// FIREBASE
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
let auth, db, user;
function initFirebase() {
    if(!firebaseConfig) return;
    firebase.initializeApp(firebaseConfig);
    auth = firebase.auth(); db = firebase.firestore();
}
async function toggleCloudSync() {
    if(!auth) initFirebase();
    if(auth && !user) {
        if(typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await auth.signInWithCustomToken(__initial_auth_token);
        else await auth.signInAnonymously();
    }
}
if(typeof firebase!=='undefined') {
    initFirebase();
    if(auth) auth.onAuthStateChanged(u => {
        user = u;
        document.getElementById('cloudBtn').classList.toggle('synced', !!u);
        if(u) loadCloudData();
    });
}
async function loadCloudData() {
    if(!user) return;
    const snap = await db.collection('artifacts').doc('zavana-v16').collection('users').doc(user.uid).collection('settings').doc('config').get();
    if(snap.exists) {
        const d = snap.data();
        if(d.coins) { COINS = d.coins; renderGrid(); changeTimeframe(CURRENT_TF); }
    }
}
async function saveCloudData() {
    if(!user) return;
    await db.collection('artifacts').doc('zavana-v16').collection('users').doc(user.uid).collection('settings').doc('config').set({ coins: COINS, email: EMAIL_CONFIG });
}

// START
const checkLib = setInterval(() => { if (typeof LightweightCharts !== 'undefined') { clearInterval(checkLib); startApp(); } }, 200);
</script>
</body>
</html>
