<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>ZAVANA Ockhand Tage ACCESS</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{ 
    --bg-base: #0b0e11; 
    --bg-card: #151a1f; 
    --bg-hover: #2b3139;
    --text-primary: #eaecef; 
    --text-secondary: #848e9c; 
    --gold: #FFD700; 
    --binance-green: #0ECB81; 
    --binance-red: #F6465D; 
    --border: #2b3139;
    --neon-blue: #00f0ff;
  }
  
  body{background:var(--bg-base); color:var(--text-primary); font-family:'IBM Plex Sans', sans-serif; margin:0; padding-bottom:60px; -webkit-font-smoothing: antialiased;}
  
  /* LAYOUT */
  .app-container { max-width:1600px; margin:0 auto; padding:16px; }
  
  /* HEADER */
  .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:16px; }
  .brand { font-size:24px; font-weight:800; color:var(--text-primary); letter-spacing:1px; display:flex; align-items:center; gap:10px; }
  .brand span { color:var(--gold); font-size:12px; font-weight:500; background:rgba(255, 215, 0, 0.1); padding:2px 8px; border-radius:4px; border:1px solid rgba(255,215,0,0.3); }
  
  /* CONNECTION STATUS */
  .conn-status { font-size:12px; font-weight:500; color:var(--text-secondary); display:flex; align-items:center; gap:6px; background:var(--bg-card); padding:6px 12px; border-radius:4px; border:1px solid var(--border); }
  .dot { width:8px; height:8px; border-radius:50%; background:var(--text-secondary); }
  .dot.active { background:var(--binance-green); box-shadow:0 0 6px var(--binance-green); }

  /* TIMEFRAME SELECTOR */
  .toolbar { display:flex; gap:6px; overflow-x:auto; padding-bottom:8px; margin-bottom:16px; scrollbar-width:none; border-bottom:1px solid var(--border); }
  .tf-btn { 
    background:transparent; color:var(--text-secondary); border:none; padding:6px 14px; 
    cursor:pointer; font-weight:600; font-size:13px; border-radius:4px; transition:0.2s; white-space:nowrap;
  }
  .tf-btn:hover { color:var(--text-primary); background:var(--bg-hover); }
  .tf-btn.active { color:var(--gold); background:rgba(255, 215, 0, 0.1); border: 1px solid rgba(255,215,0,0.2); }

  /* GRID */
  .grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(380px, 1fr)); gap:16px; }

  /* CARD DESIGN */
  .card { background:var(--bg-card); border-radius:10px; padding:14px; position:relative; display:flex; flex-direction:column; gap:10px; border:1px solid transparent; transition:0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
  .card:hover { border-color:var(--border); transform: translateY(-2px); }
  .card.gold-pair { border: 1px solid rgba(255, 215, 0, 0.2); background: linear-gradient(180deg, #151a1f 0%, #1f1b0f 100%); }

  /* Card Header */
  .c-head { display:flex; justify-content:space-between; align-items:center; }
  .pair-info { display:flex; align-items:center; gap:10px; }
  .pair-icon { width:28px; height:28px; border-radius:50%; background:#222; }
  .pair-name { font-size:16px; font-weight:700; color:var(--text-primary); }
  .trend-badge { font-size:11px; padding:3px 8px; border-radius:4px; background:var(--bg-hover); color:var(--text-secondary); font-weight:600; }
  .trend-badge.bull { color:#000; background:var(--binance-green); }
  .trend-badge.bear { color:#fff; background:var(--binance-red); }

  .price-box { text-align:right; }
  .live-price { font-size:18px; font-weight:600; font-family:'IBM Plex Sans', monospace; }
  
  /* CHART */
  .chart-wrapper { height:180px; width:100%; border-radius:6px; overflow:hidden; border:1px solid var(--border); position:relative; background: #0b0e11; }
  .loading-overlay { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(11,14,17,0.95); display:flex; justify-content:center; align-items:center; z-index:10; font-size:12px; color:var(--text-secondary); }

  /* SMART TARGET AI PANEL (NEW) */
  .ai-panel { 
    background: rgba(0,0,0,0.2); border: 1px solid var(--border); border-radius: 6px; 
    padding: 8px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; text-align: center;
    opacity: 0.5; transition: 0.3s;
  }
  .ai-panel.active { opacity: 1; border-color: var(--text-secondary); }
  .ai-box { display: flex; flex-direction: column; }
  .ai-label { font-size: 9px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
  .ai-val { font-size: 13px; font-weight: 600; font-family: monospace; color: var(--text-primary); }
  .ai-val.tp { color: var(--binance-green); }
  .ai-val.sl { color: var(--binance-red); }

  /* ACTION PANEL */
  .action-panel { display:flex; gap:10px; margin-top:2px; }
  .signal-btn { 
    flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:10px; border-radius:6px; 
    font-weight:700; font-size:14px; text-transform:uppercase; cursor:default; transition:0.3s;
    background:var(--bg-hover); color:var(--text-secondary); opacity: 0.3; min-height: 50px;
  }
  .score-val { font-size: 11px; font-weight: 500; opacity: 0.8; margin-top: 2px; }

  /* Active Signals */
  .signal-btn.buy.active { background:var(--binance-green); color:#000; opacity: 1; }
  .signal-btn.sell.active { background:var(--binance-red); color:#fff; opacity: 1; }
  
  /* SNIPER MODE (Skor 8+) */
  .signal-btn.sniper { animation: pulseSniper 0.8s infinite; border: 1px solid #fff; box-shadow: 0 0 20px currentColor; opacity: 1; }
  @keyframes pulseSniper { 0%{transform:scale(1);} 50%{transform:scale(1.02);} 100%{transform:scale(1);} }

  /* PROFIT METER */
  .meter-box { background:var(--bg-base); padding:10px; border-radius:6px; border:1px solid var(--border); }
  .meter-head { display:flex; justify-content:space-between; font-size:11px; color:var(--text-secondary); margin-bottom:6px; }
  .progress-bg { height:6px; background:var(--bg-hover); border-radius:3px; overflow:hidden; }
  .progress-fill { height:100%; width:0%; transition:width 0.5s; border-radius:3px; }
  
  .fill-safe { background:var(--binance-green); }
  .fill-warn { background:var(--gold); }
  .fill-max { background:var(--binance-red); }

  /* COLORS TEXT */
  .c-up { color:var(--binance-green); }
  .c-down { color:var(--binance-red); }
  .c-wait { color:var(--text-secondary); }

</style>
</head>
<body>

<div class="app-container">
  <!-- Header -->
  <div class="header">
    <div class="brand">ZAVANA <span>Ockhand Tage</span></div>
    <div class="conn-status">
      <div class="dot" id="wsDot"></div>
      <span id="wsText">System Initializing...</span>
    </div>
  </div>

  <!-- Timeframe Selector -->
  <div class="toolbar" id="tfToolbar"></div>

  <!-- Main Grid -->
  <div class="grid" id="grid"></div>
</div>

<!-- Audio Source (Base64 for reliability) -->
<audio id="alertSound" src="data:audio/wav;base64,UklGRl9vT1BXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"></audio>

<!-- Scripts -->
<script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>

<script>
/* =========================================
   1. CONFIGURATION
   ========================================= */
const COINS = [
  "PAXGUSDT", "BTCUSDT", "ETHUSDT", "BNBUSDT", 
  "SOLUSDT", "XRPUSDT", "DOGEUSDT", "ADAUSDT", "TRXUSDT"
];

// MENGEMBALIKAN SEMUA TIME FRAME
const TIMEFRAMES = [
  { label: '1m',  ws: '1m',  cc: 'histominute', limit: 60, desc: 'Scalping (Risky)' },
  { label: '5m',  ws: '5m',  cc: 'histominute', limit: 300, desc: 'Scalping (Rec)' },
  { label: '15m', ws: '15m', cc: 'histominute', limit: 900, desc: 'Day Trade (Best)' },
  { label: '1H',  ws: '1h',  cc: 'histohour',   limit: 60, desc: 'Swing (Accurate)' },
  { label: '4H',  ws: '4h',  cc: 'histohour',   limit: 240, desc: 'Sniper' },
  { label: '1D',  ws: '1d',  cc: 'histoday',    limit: 30, desc: 'Investing' }
];

let CURRENT_TF = TIMEFRAMES[2]; // Default 15m
let ws = null;
const charts = new Map();
const marketData = new Map();
const audioCooldown = new Map(); 

/* =========================================
   2. INITIALIZATION
   ========================================= */
function init() {
  renderToolbar();
  renderGrid();
  changeTimeframe(CURRENT_TF);
  
  const AudioContext = window.AudioContext || window.webkitAudioContext;
  if (AudioContext) {
      window.audioCtx = new AudioContext();
  }
}

function playAlert() {
    if (window.audioCtx) {
        const osc = window.audioCtx.createOscillator();
        const gain = window.audioCtx.createGain();
        osc.connect(gain);
        gain.connect(window.audioCtx.destination);
        osc.type = 'sine';
        osc.frequency.setValueAtTime(880, window.audioCtx.currentTime); // High pitch
        gain.gain.setValueAtTime(0.1, window.audioCtx.currentTime);
        osc.start();
        osc.stop(window.audioCtx.currentTime + 0.2); // 0.2 seconds beep
    }
}

function renderToolbar() {
  const bar = document.getElementById('tfToolbar');
  bar.innerHTML = '';
  TIMEFRAMES.forEach(tf => {
    const btn = document.createElement('button');
    btn.className = `tf-btn ${tf.label === CURRENT_TF.label ? 'active' : ''}`;
    btn.textContent = tf.label;
    btn.onclick = () => changeTimeframe(tf);
    bar.appendChild(btn);
  });
}

function renderGrid() {
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  
  COINS.forEach(sym => {
    const base = sym.replace('USDT','');
    const isGold = sym === "PAXGUSDT";
    
    // Icon
    let iconUrl = `https://assets.coincap.io/assets/icons/${base.toLowerCase()}@2x.png`;
    if(isGold) iconUrl = "https://assets.coincap.io/assets/icons/paxg@2x.png";
    
    const el = document.createElement('div');
    el.className = isGold ? 'card gold-pair' : 'card';
    el.id = `card-${sym}`;
    
    el.innerHTML = `
      <div class="c-head">
        <div class="pair-info">
          <img src="${iconUrl}" class="pair-icon" onerror="this.style.display='none'">
          <div class="pair-name" style="${isGold ? 'color:var(--gold)' : ''}">${isGold ? 'GOLD' : base} / USDT</div>
          <div class="trend-badge" id="trend-${sym}">SCANNING</div>
        </div>
        <div class="price-box">
          <div class="live-price" id="price-${sym}" style="${isGold ? 'color:var(--gold)' : ''}">---</div>
        </div>
      </div>

      <div class="chart-wrapper" style="${isGold ? 'border-color:rgba(255,215,0,0.2)' : ''}">
        <div class="loading-overlay" id="load-${sym}">Loading Data...</div>
        <div id="chart-${sym}" style="width:100%; height:100%"></div>
      </div>
      
      <!-- SMART TARGET AI PANEL -->
      <div class="ai-panel" id="ai-${sym}">
        <div class="ai-box">
           <span class="ai-label">Entry</span>
           <span class="ai-val" id="val-entry-${sym}">-</span>
        </div>
        <div class="ai-box">
           <span class="ai-label">Stop Loss</span>
           <span class="ai-val sl" id="val-sl-${sym}">-</span>
        </div>
        <div class="ai-box">
           <span class="ai-label">Take Profit</span>
           <span class="ai-val tp" id="val-tp-${sym}">-</span>
        </div>
      </div>

      <div class="action-panel">
        <div class="signal-btn buy" id="btn-buy-${sym}">
            <span>BUY</span>
            <span class="score-val" id="sc-buy-${sym}">0.0</span>
        </div>
        <div class="signal-btn sell" id="btn-sell-${sym}">
            <span>SELL</span>
            <span class="score-val" id="sc-sell-${sym}">0.0</span>
        </div>
      </div>

      <div class="meter-box">
        <div class="meter-head">
          <span>RSI: <b id="rsi-${sym}">-</b></span>
          <span id="tp-msg-${sym}">Ready</span>
        </div>
        <div class="progress-bg">
          <div class="progress-fill fill-safe" id="meter-${sym}"></div>
        </div>
      </div>
    `;
    grid.appendChild(el);

    // Chart Setup
    const container = document.getElementById(`chart-${sym}`);
    const chart = LightweightCharts.createChart(container, {
      layout: { backgroundColor: '#0b0e11', textColor: '#848e9c', fontSize: 10, fontFamily: 'IBM Plex Sans' },
      grid: { vertLines: { color: '#151a1f' }, horzLines: { color: '#151a1f' } },
      rightPriceScale: { borderVisible: false, scaleMargins: { top: 0.1, bottom: 0.1 } },
      timeScale: { visible: false, borderVisible: false },
      crosshair: { vertLine: { visible: false }, horzLine: { visible: false } },
      handleScroll: false, handleScale: false
    });
    
    const series = chart.addCandlestickSeries({
      upColor: '#0ECB81', downColor: '#F6465D', borderVisible: false, wickUpColor: '#0ECB81', wickDownColor: '#F6465D'
    });

    const emaLine = chart.addLineSeries({ color: isGold ? '#FFD700' : '#3b82f6', lineWidth: 1, crosshairMarkerVisible: false });

    new ResizeObserver(e => {
       if(e[0]) chart.applyOptions({ width: e[0].contentRect.width, height: e[0].contentRect.height });
    }).observe(container);

    charts.set(sym, { chart, series, emaLine });
    marketData.set(sym, []);
  });
}

/* =========================================
   3. DATA ENGINE
   ========================================= */
async function changeTimeframe(newTf) {
  CURRENT_TF = newTf;
  document.querySelectorAll('.tf-btn').forEach(b => {
    b.classList.toggle('active', b.textContent === newTf.label);
  });
  
  if(ws) ws.close();
  document.getElementById('wsDot').className = 'dot';
  document.getElementById('wsText').textContent = 'Fetching History...';

  for (const sym of COINS) {
    document.getElementById(`load-${sym}`).style.display = 'flex';
    marketData.set(sym, []);
    
    const hist = await fetchHistory(sym, newTf);
    if(hist.length > 0) {
      marketData.set(sym, hist);
      const cObj = charts.get(sym);
      try {
        cObj.series.setData(hist);
        const emaData = calculateEMAData(hist, 200);
        cObj.emaLine.setData(emaData);
      } catch(e) {}
      document.getElementById(`load-${sym}`).style.display = 'none';
      analyze(sym, hist, cObj);
    }
  }
  startWS(newTf.ws);
}

async function fetchHistory(sym, tf) {
  const base = sym.replace('USDT','');
  const url = `https://min-api.cryptocompare.com/data/v2/${tf.cc}?fsym=${base}&tsym=USDT&limit=200`;
  try {
    const res = await fetch(url);
    const json = await res.json();
    if(json.Response === 'Success') {
      return json.Data.Data.map(d => ({
        time: d.time, open: d.open, high: d.high, low: d.low, close: d.close, volume: d.volumeto
      }));
    }
  } catch(e) {}
  return [];
}

function startWS(interval) {
  const streams = COINS.map(c => `${c.toLowerCase()}@kline_${interval}`).join('/');
  ws = new WebSocket(`wss://stream.binance.com:9443/stream?streams=${streams}`);
  
  ws.onopen = () => {
    document.getElementById('wsDot').classList.add('active');
    document.getElementById('wsText').textContent = `LIVE (${CURRENT_TF.label})`;
  };

  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    const k = msg.data.k;
    const sym = msg.data.s;
    const candle = {
      time: k.t/1000, open: +k.o, high: +k.h, low: +k.l, close: +k.c, volume: +k.v
    };
    handleStream(sym, candle);
  };
}

function handleStream(sym, candle) {
  const arr = marketData.get(sym);
  if(!arr) return;
  const last = arr[arr.length-1];
  
  if (!last) { arr.push(candle); } 
  else if (candle.time < last.time) { return; }
  else if (last.time === candle.time) { arr[arr.length-1] = candle; } 
  else { arr.push(candle); if(arr.length > 300) arr.shift(); }
  
  const cObj = charts.get(sym);
  if(cObj) {
    try { 
        cObj.series.update(candle);
        const emaVal = calcEMA(arr, 200);
        if(emaVal) cObj.emaLine.update({ time: candle.time, value: emaVal });
    } catch(e) {}
    updatePriceUI(sym, candle);
    analyze(sym, arr, cObj);
  }
}

function updatePriceUI(sym, candle) {
  const pEl = document.getElementById(`price-${sym}`);
  const old = parseFloat(pEl.dataset.p || 0);
  pEl.textContent = candle.close.toFixed(candle.close < 1 ? 4 : 2);
  pEl.className = `live-price ${candle.close >= old ? 'c-up' : 'c-down'}`;
  pEl.dataset.p = candle.close;
}

/* =========================================
   4. CORE ANALYTICS (V8 UPGRADE)
   ========================================= */
function analyze(sym, data, cObj) {
  if (!data || data.length < 50) return;

  const last = data[data.length-1];
  const prev = data[data.length-2];
  
  // Indicators
  const rsi = calcRSI(data, 14);
  const bb = calcBB(data, 20, 2);
  const ema200 = calcEMA(data, 200);
  const atr = calcATR(data, 14); 
  const avgVol = calcAvgVol(data, 20);
  
  // Trend
  let trend = "SIDEWAYS";
  if (ema200 && last.close > ema200) trend = "BULLISH";
  if (ema200 && last.close < ema200) trend = "BEARISH";
  
  // Volume Logic
  const volumeRatio = last.volume / (avgVol || 1); 
  const isHighVol = volumeRatio > 1.2;

  // SCORING
  let buyScore = 1.0;
  let sellScore = 1.0;

  // Buy Score Factors
  if (last.close < bb.lower) buyScore += 2; 
  if (last.close > last.open && prev.close < prev.open) buyScore += 1;
  if (rsi < 40) buyScore += 1;
  if (rsi < 30) buyScore += 2;
  if (trend === "BULLISH") buyScore += 2;
  if (isHighVol && last.close > last.open) buyScore += 2;

  // Sell Score Factors
  if (last.close > bb.upper) sellScore += 2;
  if (last.close < last.open && prev.close > prev.open) sellScore += 1;
  if (rsi > 60) sellScore += 1;
  if (rsi > 70) sellScore += 2;
  if (trend === "BEARISH") sellScore += 2;
  if (isHighVol && last.close < last.open) sellScore += 2;

  buyScore = Math.min(10, buyScore);
  sellScore = Math.min(10, sellScore);
  
  let signal = "WAIT";
  if (buyScore >= 5.5 && buyScore > sellScore) signal = "BUY";
  if (sellScore >= 5.5 && sellScore > buyScore) signal = "SELL";

  // SMART TARGET AI (ATR BASED)
  let aiData = { entry: '-', sl: '-', tp: '-' };
  
  if (signal === "BUY") {
      const slPrice = last.close - (atr * 2);
      const tpPrice = last.close + (atr * 3);
      aiData = { 
          entry: last.close.toFixed(2), 
          sl: slPrice.toFixed(2), 
          tp: tpPrice.toFixed(2) 
      };
  } else if (signal === "SELL") {
      const slPrice = last.close + (atr * 2);
      const tpPrice = last.close - (atr * 3);
      aiData = { 
          entry: last.close.toFixed(2), 
          sl: slPrice.toFixed(2), 
          tp: tpPrice.toFixed(2) 
      };
  }

  // AUDIO ALERT SYSTEM
  const now = Date.now();
  const lastAlert = audioCooldown.get(sym) || 0;
  const isSniper = (signal === "BUY" && buyScore >= 8) || (signal === "SELL" && sellScore >= 8);
  
  if (isSniper && (now - lastAlert > 60000)) {
      playAlert(); 
      audioCooldown.set(sym, now);
      console.log(`DING! Signal ${sym} Score ${Math.max(buyScore, sellScore)}`);
  }

  // TP Alert Logic
  let tpAlert = false;
  const heat = Math.abs(rsi - 50) * 2;
  if (rsi > 80 || rsi < 20) tpAlert = true;

  // UPDATE UI
  updateSignalUI(sym, signal, buyScore, sellScore, trend, heat, tpAlert, rsi, aiData);
  
  // Chart Markers
  if(cObj) {
    let markers = [];
    if(signal === "BUY" && buyScore >= 5.5) {
        markers.push({ time: last.time, position: 'belowBar', color: '#0ECB81', shape: 'arrowUp', text: `B:${buyScore.toFixed(1)}` });
    }
    if(signal === "SELL" && sellScore >= 5.5) {
        markers.push({ time: last.time, position: 'aboveBar', color: '#F6465D', shape: 'arrowDown', text: `S:${sellScore.toFixed(1)}` });
    }
    try { cObj.series.setMarkers(markers); } catch(e){}
  }
}

function updateSignalUI(sym, signal, bScore, sScore, trend, heat, tpAlert, rsi, aiData) {
    const btnBuy = document.getElementById(`btn-buy-${sym}`);
    const btnSell = document.getElementById(`btn-sell-${sym}`);
    const scBuy = document.getElementById(`sc-buy-${sym}`);
    const scSell = document.getElementById(`sc-sell-${sym}`);
    const trendBadge = document.getElementById(`trend-${sym}`);
    const meter = document.getElementById(`meter-${sym}`);
    const tpMsg = document.getElementById(`tp-msg-${sym}`);
    const rsiTxt = document.getElementById(`rsi-${sym}`);
    const aiPanel = document.getElementById(`ai-${sym}`);

    btnBuy.className = 'signal-btn buy';
    btnSell.className = 'signal-btn sell';
    scBuy.textContent = bScore.toFixed(1);
    scSell.textContent = sScore.toFixed(1);
    
    trendBadge.textContent = trend;
    trendBadge.className = `trend-badge ${trend === "BULLISH" ? "bull" : (trend === "BEARISH" ? "bear" : "")}`;

    // Update AI Panel
    document.getElementById(`val-entry-${sym}`).textContent = aiData.entry;
    document.getElementById(`val-sl-${sym}`).textContent = aiData.sl;
    document.getElementById(`val-tp-${sym}`).textContent = aiData.tp;
    
    if (signal !== "WAIT") {
        aiPanel.classList.add('active');
    } else {
        aiPanel.classList.remove('active');
    }

    if(signal === "BUY") {
        btnBuy.classList.add('active');
        if(bScore >= 8.5) btnBuy.classList.add('sniper');
    }
    if(signal === "SELL") {
        btnSell.classList.add('active');
        if(sScore >= 8.5) btnSell.classList.add('sniper');
    }

    meter.style.width = `${heat}%`;
    meter.className = 'progress-fill';
    
    if(tpAlert) {
        meter.classList.add('fill-max');
        tpMsg.textContent = "TAKE PROFIT!";
        tpMsg.style.color = "var(--gold)";
    } else {
        meter.classList.add(heat > 60 ? 'fill-warn' : 'fill-safe');
        tpMsg.textContent = "Running...";
        tpMsg.style.color = "var(--text-secondary)";
    }

    rsiTxt.textContent = rsi.toFixed(1);
    rsiTxt.className = rsi > 70 ? 'c-down' : (rsi < 30 ? 'c-up' : 'c-wait');
}

/* =========================================
   5. MATH HELPERS
   ========================================= */
function calcEMA(data, p) {
    if(data.length < p) return null;
    const k = 2 / (p + 1);
    let ema = data[0].close;
    for (let i = 1; i < data.length; i++) {
        ema = (data[i].close * k) + (ema * (1 - k));
    }
    return ema;
}
function calculateEMAData(data, p) {
    const result = [];
    if(data.length < p) return result;
    const k = 2 / (p + 1);
    let ema = data[0].close;
    for (let i = 0; i < data.length; i++) {
        ema = (data[i].close * k) + (ema * (1 - k));
        if(i >= p) result.push({ time: data[i].time, value: ema });
    }
    return result;
}
function calcRSI(data, p) {
  if(data.length < p+1) return 50;
  let g=0, l=0;
  for(let i=data.length-p; i<data.length; i++){
    const d = data[i].close - data[i-1].close;
    if(d>0) g+=d; else l-=d;
  }
  if(l===0) return 100;
  return 100 - (100/(1+(g/l)));
}
function calcBB(data, p, m) {
  if(data.length < p) return {upper:0, lower:0};
  const slice = data.slice(-p);
  const avg = slice.reduce((a,b)=>a+b.close,0)/p;
  const sqDiff = slice.map(x => Math.pow(x.close-avg, 2));
  const dev = Math.sqrt(sqDiff.reduce((a,b)=>a+b,0)/p);
  return { upper: avg + (dev*m), lower: avg - (dev*m) };
}
function calcAvgVol(data, p) {
  if(data.length < p) return 1;
  const slice = data.slice(-p);
  return slice.reduce((a,b)=>a+b.volume,0)/p;
}
function calcATR(data, p) {
    if(data.length < p+1) return 0;
    let trSum = 0;
    for(let i = data.length - p; i < data.length; i++) {
        const high = data[i].high;
        const low = data[i].low;
        const prevClose = data[i-1].close;
        const tr = Math.max(high - low, Math.abs(high - prevClose), Math.abs(low - prevClose));
        trSum += tr;
    }
    return trSum / p;
}

init();
</script>
</body>
</html>
